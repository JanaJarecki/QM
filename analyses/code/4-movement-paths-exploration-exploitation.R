# -------------------------------------------------------------------------
### Jana Jarecki
### 28. July 2017
### Analyze exploration/exploitation behavior
# -------------------------------------------------------------------------
library(data.table) # fast data loading and manipulation
source("utils.R") # Helper functions

# NOTE. ALL PATHS ARE RELATIVE TO THE CURRENT DIRECTORY
# Load and prepare/prep data
gdata <- fread("../../data/processed/gameplay.csv") # Successes
pdata <- rbind(fread("../../data/processed/gamepaths_L3.csv"), # Paths
               fread("../../data/processed/gamepaths_L4.csv"))
prep.gdata() # make variables, see utils.R
prep.pdata() # make variables, takes a while, see utils.R


# --------------------------------------------------------------------------
# These analysis are exploratory
# Extract one path (called hit)
aHit <- pdata[, sample(hitID, 1)]

# This is how we can plot a path
# Note:
# the raw X- and Y-mouse movement data are NOT
# on the same scale. Data are scaled between -200 and 0 on the y-xis
# and between 0 and 3 on the x-axis. Therefore we re-scale them and use 
# X.smooth and Y.smooth in the calculations
ggplot(pdata[hitID == aHit]) +geom_path(aes(X,Y,group=hitID)) +geom_path(aes(X.smooth,Y.smooth,group=hitID), color = "red")

# Define exploration behavior:
# Exploration is being defined as cases where the next path has a large distance to the previous path, where distancs is defined as x-y-t-distance.
# i.e. the three-dimensional euclidean distance
# This also accounts for changes in speed.
# Compute distances between a path and the previous path,
# using only the number of points of the shorter paths if they are unqeually long
# tdata <- pdata[ID %in% sample(ID, 3)] #participant who passed the level
pdata[, pairs.even := cut(hitNr, seq(0,max(hitNr),2), label=F), by = .(ID, levelName)]
pdata[, pairs.uneven := cut(hitNr, seq(1,max(hitNr)+1,2), label=F), by = .(ID, levelName)]
pdata[, dist.even := compute.distance(.SD), by = .(levelName, ID, pairs.even)]
pdata[, dist.uneven := compute.distance(.SD), by = .(levelName, ID, pairs.uneven)]
pdata[, dist := dist.even]
pdata[is.na(dist.even), dist := dist.uneven]
pdata[, c('dist.even', 'dist.uneven') := NULL]
# Store the distances
fwrite(pdata, "../../processed/pathsL3L4-distances-between-consecutive-paths.csv")

explorationL3 <- pdata[levelName=="L3", .(mwExploration = mean(dist, na.rm=T)), by = ID]
fidelitiesL4 <- gdata[levelName=="L4", .(mwFidelity = mean(highestFidelity)), by = list(levelName, ID, hitNr)][, .(mwFidelity = mean(mwFidelity)), by = list(levelName, ID)]
combined <- merge(explorationL3, fidelitiesL4)
ggplot(combined, aes(x=mwExploration, y=mwFidelity)) +geom_point() +geom_smooth(method="lm")


firstSuccess <- gdata[levelName=="L4", .(firstSuccess = min(100, min(attempts[currentCompletions==1]))), by = ID]
combined <- merge(explorationL3, firstSuccess)
ggplot(combined, aes(x=mwExploration, y=100-firstSuccess)) +geom_point() +geom_smooth(method="lm")



tdata <- pdata[levelName=="L4" & ID =="YLGW036497_832422017" & hitNr < 3]
tdata[, X := X/3 * 100]
tdata[, Y := (Y+200)/2]
cols <- c('dist.x.y.t', 'dist.x', 'dist.y', 'dist.t', 'dist.x.y', 'dist.x.t', 'dist.y.t')
tdata[, c(cols) := compute.distance(.SD), by = list(levelName, ID, pairs.even)]
tdata
source("utils/plot.distance.R")
plot.distance(tdata, "dist.x")




tdata[, X.smooth := loess(X ~ id, span = 0.1)$fitted, by = hitNr]
tdata[, Y.smooth := loess(Y ~ id, span = 0.1)$fitted, by = hitNr]

tdata.smooth <- tdata[, .(X = lpridge(x = id, y = X, bandwidth = 5)$est,
                          Y = lpridge(x = id, y = Y, bandwidth = 5)$est
    ), by = hitNr]
tdata.smooth[, dt := diff(Y)/diff(X)]

ggplot() +geom_path(data = tdata, aes(X,Y,group=hitNr)) +
    geom_path(data = tdata.smooth, aes(X,Y,group=hitNr), color = "red") +
    facet_wrap(~hitNr, ncol = 1)

tdata[, dt := dist(c(X,X.lag),, by = hitNr]

scene = list(camera = list(
    eye = list(x = .9, y = -2, z = 1)))

p2 <- plot_ly(tdata[hitNr==1], x = ~X, y = ~dt, z = ~Y, type = 'scatter3d', mode = 'lines', line = list(width = 5, color = "grey", reverscale = FALSE)) %>%
    add_trace(data = tdata.smooth[hitNr==1], x = ~X, y = ~dt, z = ~Y, line = list(width = 2, revscale = FALSE, color = 'red')) %>%
    layout(scene = scene)   
p2

tdata

tdata[, c('X.smooth.lag','Y.smooth.lag') := .(
        c(NA, X[-.N]),
        c(NA, Y[-.N])), by = list(ID, hitNr, levelName)]
tdata[, dt.smooth := as.vector(dist( cbind(c(X.smooth,X.smooth.lag), c(Y.smooth,Y.smooth.lag)) )), by = list(id, hitNr, ID, levelName)]



tdatalong <- tdata[hitNr==1, c("X","Y")]
tdatalong[, type := "Original"]
tdatalong <- rbind(tdatalong, tdata[hitNr==1, c("X.smooth","Y.smooth")])
p2 <- plot_ly(tdata[hitNr==1], x = ~X.smooth, y = ~dt.smooth, z = ~Y.smooth, type = 'scatter3d', mode = 'lines', line = list(width = 2, color = "red", reverscale = FALSE)) %>%
    add_trace(x = ~X, y = ~dt, z = ~Y, line = list(width = 2, revscale = FALSE, color = 'grey')) %>%
    layout(scene = scene)
    
p2

library(plotly)



p2 <- plot_ly(tdata, x = ~X.smooth, y = ~dt.smooth, z = ~Y.smooth, type = 'scatter3d', mode = 'lines',
        opacity = 1, line = list(width = 6, color = ~hitNr, reverscale = FALSE)) %>% layout(scene = scene)
p2

pdata[, range(Y)]
# x 0 - 3
# y -200 - 0 


# regressin coefficients
regression <- pdata[, .(mw = mean(dist, na.rm = TRUE), hitNr = unique(hitNr)), by = list(ID, hitNr)][, as.list(coef(lm(mw ~ hitNr))), by = list(levelName, ID)]

fidelities <- gdata[, .(mwFidelity = mean(highestFidelity)), by = list(levelName, ID, hitNr)][, .(mwFidelity = mean(mwFidelity)), by = list(levelName, ID)]
fidelities

combined <- merge(regression, fidelities)

ggplot(combined, aes(x=hitNr, y=mwFidelity)) +geom_point() +geom_smooth() +facet_wrap(~levelName)

# source("utils/plot.distance.R")
# plot.distance(tdata)

ggplot(tdata, aes(x=hitNr, group=hitNr)) +
    geom_pointrange(aes(y=mw, ymin=mw-sd, ymax=mw+sd, color = lastPointFidelity), size=.7) +
    #geom_boxplot(aes(y=dist, fill = lastPointFidelity), outlier.shape=NA, coef = 0) +
    facet_grid(ID~.)


